const cds = require ('../index')
const app = cds.require('express')()

app.run = (callback) => {

    let [,cmd] = process.argv
    if (!cmd || cmd.endsWith('cds'))  cmd = 'cds'
    if (!cmd || cmd.endsWith('cds/bin/run.js'))  cmd = 'cds run in '+ process.cwd()

    const index_html = `
    <html>
        <body style="margin: 44px; font-family: xChalkboard, sans-serif">
            <h1 style="font-weight:200">Welcome to <i>cds.services</i></h1>
            <p> These are the services and entities currently served through
            <br><i>${cmd} ${process.argv.slice(2).join(' ')}</i>...
            ${ cds.service.providers.map (service => {
                const srv = service.path
                return `
                <h3>
                    <a href="${srv}">${srv}</a>/
                    <a href="${srv}/$metadata">$metadata</a>
                </h3>
                <ul>
                    ${Object.keys (service.entities).map (e =>
                        `\t\t\t\t<li><a href="${srv}/${e}">${e}</a></li>
                    `).join('')}
                </ul>`
            }) .join('')}
        </body>
    </html>
    `
    app.get ('/', (_,res) => res.send (index_html))

    const { PORT=4004 } = process.env
    return app.listen (PORT, callback || (
        () => console.log(`[cds] - server listens at http://localhost:${PORT}\n`)
    ))

}

module.exports = app
/* eslint no-console:off */