const cds = require('../../cds')
const {generateUUID} = require('@sap/cds-ql')
const {DB_CONNECTION_MISSING} = require('../utils/constants')

const _addKeysToData = (data, keys) => {
  if (!keys) {
    return
  }

  for (const key of Object.keys(keys)) {
    if (keys[key].type === 'cds.UUID' && data[key] === undefined) {
      data[key] = generateUUID()
    }
  }
}

/**
 * Generic Handler for CREATE requests.
 * In case of success it returns the created entry.
 *
 * @param context - operation object, that provides error, continuation and other functions as well as information
 * regarding the current operation.
 * @alias module:handlers.onCreate
 */
const onCreate = (context) => {
  _addKeysToData(context.data, cds.reflect(context.target).keys)

  if (!context.run) {
    context.log.warn(DB_CONNECTION_MISSING)
    return Promise.resolve(context.data)
  }

  return context.run(context.query)
    .then(() => {
      return context.data
    })
}

module.exports = onCreate
