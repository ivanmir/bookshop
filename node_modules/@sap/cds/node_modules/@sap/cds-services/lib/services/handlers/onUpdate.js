const notFound = require('./notFound')
const {DB_CONNECTION_MISSING} = require('../utils/constants')

const _getSelectCQN = (context) => {
  const select = context.statements.SELECT.from(context.target)
  select.SELECT.where = context.query.UPDATE.where

  return select
}

/**
 * Generic Handler for UPDATE requests.
 * In case of success it returns the updated entry.
 * If the entry to be updated does not exist, it rejects with error to return a 404.
 *
 * @param context - operation object, that provides error, continuation and other functions as well as information
 * regarding the current operation.
 * @alias module:handlers.onUpdate
 */
const onUpdate = (context) => {
  if (!context.run) {
    context.log.warn(DB_CONNECTION_MISSING)
    return Promise.resolve(context.data)
  }

  return context.run(_getSelectCQN(context))
    .then((result) => {
      if (result.length === 0) {
        throw notFound(context)
      }

      context._oldData = result[0]

      return context.run(context.query)
        .then(() => {
          return Object.assign({}, result[0], context.data)
        })
    })
}

module.exports = onUpdate
