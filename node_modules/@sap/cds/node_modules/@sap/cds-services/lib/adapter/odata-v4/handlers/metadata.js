const cds = require('../../../cds')
const {toODataResult} = require('../utils/event')

const _getMetadataLocale = (service, options, locale) => {
  return cds.load(service.definition._sources)
    .then((csn) => {
      const [localized] = cds.localize(csn, [locale]).next().value

      return cds.compile.to.edmx(localized, {service: options.service})
    })
}

/**
 * Provide localized metadata handler.
 *
 * @param {Object} service
 * @param {Object} options
 * @return {Function}
 */
const metadata = (service, options) => {
  return (req, res, next) => {
    const locale = res.getContract().getLocale()

    _getMetadataLocale(service, options, locale)
      .then((metadata) => {
        next(null, toODataResult(metadata))
      })
      .catch((err) => {
        next(err)
      })
  }
}

module.exports = metadata
