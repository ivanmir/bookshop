const {FeatureNotSupported} = require('../../../errors')

const _removeId = (obj, id) => {
  const res = Object.assign({}, obj)
  delete res[`${id}`]
  return res
}

const SUPPORTED_KINDS = ['NAVIGATION.TO.ONE', 'ENTITY']
/**
 * Transform odata UPDATE request into a CQN object.
 *
 * @param context - Contains request information and utility methods like statements.
 * @param req - An odata request.
 * @private
 */
const updateToCQN = (context, req) => {
  const segments = req.getUriInfo().getPathSegments()
  const segment = segments[segments.length - 1]

  if (SUPPORTED_KINDS.includes(segment.getKind())) {
    const key = segment.getKeyPredicates()[0].getEdmRef().getName()
    const value = segment.getKeyPredicates()[0].getText()

    return context.statements.UPDATE(context.target)
      .set(_removeId(context.data, key))
      .where(key, value)
  }

  throw new FeatureNotSupported(`UPDATE of kind ${segment.getKind()} is not supported`)
}

module.exports = updateToCQN
