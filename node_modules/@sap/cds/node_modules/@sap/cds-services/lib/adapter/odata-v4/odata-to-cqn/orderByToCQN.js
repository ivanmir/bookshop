const _error = (expression) => {
  if (expression.getKind() === 3) {
    return expression
  }

  const {QueryOptions: {ORDERBY}} = require('@sap/odata-v4')
  const {FeatureNotSupported} = require('../../../errors')

  throw new FeatureNotSupported(`QueryOption ${ORDERBY} with kind ${expression.getKind()} is not supported`)
}

const orderbyToCQN = (cqnPartial, orderBy) => {
  if (!orderBy || orderBy.length === 0) {
    return
  }

  if (!cqnPartial.orderBy) {
    cqnPartial.orderBy = []
  }

  for (const order of orderBy) {
    const expression = _error(order.getExpression())

    cqnPartial.orderBy.push({
      ref: [expression.getPathSegments()[0].getProperty().getName()],
      sort: (order.isDescending()) ? 'desc' : 'asc'
    })
  }
}

module.exports = orderbyToCQN
