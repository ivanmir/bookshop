/**
 * End of an odata-v4 batch
 * @return {Function}
 */
const end = (odataErr, odataContext, done) => {
  // Might not be added or already removed. In any case means no DB client left.
  if (!odataContext.applicationData || !odataContext.applicationData.endTransactionIfConnected) {
    done()
    return
  }

  const command = (odataErr || odataContext.failedRequests.length > 0) ? 'rollback' : 'commit'

  odataContext.applicationData.doNotFinishTransaction = false
  odataContext.applicationData.endTransactionIfConnected({
    _: odataContext.applicationData
  }, command)
    .then(() => {
      done()
    })
    .catch((transactionErr) => {
      done(transactionErr)
    })
}

module.exports = {
  end
}
