# Error Messages Explained

This document tries to explain some of the less-obvious error messages.

## Common Compiler Messages (Independent From Backend)

### Duplicate definitions

```
node_modules/Base/index.cds:1:6-7: Error: Duplicate definition of artifact "T"
node_modules/base/index.cds:1:6-7: Error: Duplicate definition of artifact "T"
node_modules/dep/node_modules/model/index.cds:1:8-9: Error: Duplicate definition of artifact "E"
node_modules/model/index.cds:1:8-9: Error: Duplicate definition of artifact "E"
```

Here, the CDS Compiler does consider `…/Base/index.cds` to be different to `…/base/index.cds`,
and also considers the two `…/model/index.cds` files to be the different files.
Why is that the case?  Consider the following "top-level" file

```
using from 'Base';     // upper-case 'B'!
using from 'model';
using from 'dep';
```

File node_modules/dep/index.cds` looks like:

```
using from 'base';     // lower-case 'b'!
using from 'model';
```

`node_modules/Base/index.cds` is the same file as
`node_modules/base/index.cds` on case-insensitive file systems (Windows, Mac):

```
type T: Integer;
```

We have `node_modules/model/index.cds` and a copy of it in
`node_modules/dep/node_modules/model/index.cds`:

```
entity E { i: Integer; }
```

The technical explanation is that the CDS Compiler considers
two file names pointing to the same file if their `fs.realpath` is equal.
That means that we properly _recognize symlinks_ (Linux, Mac),
but we do _not_ recognize two files to be equal if:

* the same file is referred to with different name casing,
  which does not work on case-sensitive file systems (Linux) anyway
  (yes, we might issue a better message when `node v9.2` is widely adopted),
* a file is _copied_ within the NPM package (or when _hardlinks_ are used).

The CDL code/package can be corrected as follows:

* Use __consistent casing__ when referring to file and modules in `using from`
  (if in doubt, please check the error output provided by the CDS compiler client tool).
* __Clean up a dirty NPM installation__.  Then, the file
  `node_modules/dep/node_modules/model/index.cds` should disappear
  (or be a symlink to `node_modules/model/index.cds`).


### Extensions

```
e.cds:3:20-26: Error: No 'EXTEND artifact' within 'EXTEND CONTEXT'
e.cds:4:20-28: Error: No 'ANNOTATE artifact' within 'EXTEND SERVICE'
e.cds:5:14-22: Error: No 'ANNOTATE artifact' within 'ANNOTATE context'
e.cds:6:12-36: Error: No 'EXTEND artifact' or element definition within 'EXTEND service'
```

Artifacts (entities, types, …) should not be extended within other extensions –
just elements (and other members) are to be extended within an artifact extension.
The above messages are reported for the following CDL code:

```
context C { entity E { d: Integer; } }
service S { entity E { d: Integer; } }
extend context C { extend C.E { e: Integer; } }
extend service S { annotate S.E @Anno; }
annotate C { E @Anno; }
extend S { extend E { e: Integer; } }
```

The reason for these messages is – if we would allow it:
* The [name resolution](NameResolution.md) would become more complex due to extra rules;
  e.g. most people would expect to write just `E` instead `C.E`/`S.E` in line 3 and 4.
* The CSN would list the extensions for `E` for line 5 and 6 inside a property named `elements`
  which would look strange.
* The CDL parser expects `E` in line 6 to be an element,
  and therefore accepts CDL clauses which are useful for elements, not entities.

The CDL code can be corrected as follows:

```
context C { entity E { d: Integer; } }
service S { entity E { d: Integer; } }
extend C.E { e: Integer; }
annotate S.E @Anno;
annotate C.E @Anno;
extend S.E { e: Integer; }
```

