const path = require('path')

module.exports = {
  models: ['srv', 'services.cds', 'services.csn'],
  conf: 'service',
  dest: '${folder}/gen', //NOSONAR,
  prebuild,
  build
}

function prebuild(options) {

  if (this.resolve(path.join(options.folder, 'package.json')) && this.env.data && this.env.data.includeServiceViews !== false) {
    const db = this.all.find(m => m.category === 'db') // REVISIT: what to do in case of more than one db module?
      if (db) db.models.push(...options.models)
  }
}


function build (options) {
  const srvPath = this.resolve(path.join(options.folder, 'package.json'))

  if (!srvPath) {
    return Promise.resolve()
  }

  // build step is skipped if 'npm install' has  been triggered by cf push - in that case there is no root package.json
  if (this.resolve(path.join('package.json'))) {
    return Promise.resolve()
      .then(() => {
        return require('../../../lib/models/cdsv').collectSources(options.models, path.relative(process.cwd(), path.dirname(srvPath[0])))
      })
      .then((result) => {
        this.write(result).to('csn.json')
      })
  }
}
