const util = require('util')
const os = require('os')

/**
 * Adds a custom inspect function for console.log, repl, eval and the like
 */
module.exports.install = (obj, multiResult=true) => {

  if (!obj || typeof obj.next !== 'function')  return obj  // only format our generators

  let result = '' // need to be idempotent, and our generators cannot be called twice, so cache result
  function inspect(depth, options = {}) {
    if (result.length > 0) return result
    const cds = require('../..')
    options.skipSeparator = !multiResult // strive for a slim result and omit the --- for a single entry
    cds.write(this).to((...args) => {
      const strings = args.map(arg => typeof arg !== 'string' ? util.inspect(arg, options) : arg)
      result += strings.join(' ') + os.EOL
    }, options)
    return result.trim()
  }
  obj[util.inspect.custom] = obj.toString = inspect
  return obj
}
